image: node:11

stages:
- build
- test
- docker
- deploy

variables:
  CLI_VERSION: 7.2.3
  DOCKER_DRIVER: overlay2
  # DOCKER_HOST: tcp://docker:2375/
  DOCKER_HOST: /var/run/docker.sock
  UI_IMAGE: ${CI_REGISTRY_IMAGE}/ui
  CI_APPLICATION_TAG: $(echo ${CI_COMMIT_SHA} | cut -c1-8)


cache:
  key: $(CI_COMMIT_REF_SLUG)
  paths:
  - node_modules/
build:
  stage: build
  cache:
    key: $(CI_COMMIT_REF_SLUG)
    policy: push
    paths:
    - node_modules/
  before_script:
  - apt-get update && apt-get install -y unzip fontconfig locales gconf-service libasound2 libatk1.0-0 libc6 libcairo2 libcups2 libdbus-1-3 libexpat1 libfontconfig1 libgcc1 libgconf-2-4 libgdk-pixbuf2.0-0 libglib2.0-0 libgtk-3-0 libnspr4 libpango-1.0-0 libpangocairo-1.0-0 libstdc++6 libx11-6 libx11-xcb1 libxcb1 libxcomposite1 libxcursor1 libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 libxss1 libxtst6 ca-certificates fonts-liberation libappindicator1 libnss3 lsb-release xdg-utils wget
  - npm install --silent
  script:
  - node_modules/.bin/ng build --prod
  artifacts:
    expire_in: 2 months
    paths:
    - dist/
  # tags:
  # - docker

# test:e2e:
#   stage: test
#   allow_failure: true
#   script:
#   - node_modules/.bin/ng e2e
#   # tags:
#   # - docker

# test:karma:
#   stage: test
#   allow_failure: true
#   script:
#   - node_modules/.bin/ng test --code-coverage --progress false --watch false
#   coverage: '/Lines \W+: (\d+\.\d+)%.*/'
#   artifacts:
#     paths:
#     - coverage/
#   # tags:
#   # - docker

test:nglint:
  stage: test
  allow_failure: true
  script:
  - node_modules/.bin/ng lint
  # tags:
  # - docker

docker:
  image: docker:stable
  stage: docker
  services:
  - docker:dind
  before_script:
  - docker info
  script:
  - docker login -u deploy -p $CI_JOB_TOKEN $CI_REGISTRY
  - docker build . -t $UI_IMAGE:latest -t $UI_IMAGE:$(echo $CI_COMMIT_SHA | cut -c1-8) --build-arg SSH_PRIVATE_KEY
  - docker push $UI_IMAGE:latest
  - docker push $UI_IMAGE:$(echo $CI_COMMIT_SHA | cut -c1-8)

kube:
  image: docker:stable
  stage: deploy
  only:
    refs:
    - master
  script:
  - wget https://storage.googleapis.com/kubernetes-release/release/${KUBE_VERSION}/bin/linux/amd64/kubectl
  - chmod +x kubectl
  - echo "$KUBE" > admin.conf
  - ./kubectl --kubeconfig admin.conf set image --namespace spp deployment.v1.apps/waveform-ui waveform-ui=registry.microquake.org/rio-tinto/microquake-waveform-ui/ui:$(echo $CI_COMMIT_SHA | cut -c1-8) --record
